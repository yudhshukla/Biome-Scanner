<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Minecraft Biome Scanner</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    
    <script src="config.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }
        
        /* Cursor & UI */
        #map { cursor: none; width: 100%; height: 100%; position: absolute; }
        #cursor-layer { position: fixed; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .crosshair { width: 20px; height: 20px; position: relative; transform: translate(-50%, -50%); }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 2px black; }
        .crosshair::before { top: 9px; left: 0; width: 20px; height: 2px; }
        .crosshair::after { top: 0; left: 9px; width: 2px; height: 20px; }

        /* Sidebar */
        #sidebar {
            position: absolute; top: 0; right: -400px; width: 350px; height: 100%;
            background: rgba(16, 0, 16, 0.95); border-left: 6px solid #28022e;
            box-shadow: -10px 0 20px rgba(0,0,0,0.8); transition: right 0.3s ease-in-out;
            z-index: 100; padding: 20px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column;
        }
        #sidebar.active { right: 0; }
        .close-btn { position: absolute; top: 15px; right: 15px; cursor: pointer; font-size: 20px; color: #ff5555; }
        .sidebar-image-container { width: 100%; height: 200px; border: 4px solid #555; margin: 20px 0; background: #000; }
        .sidebar-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }
        h1 { font-size: 16px; line-height: 1.5; color: #fff; margin: 0; text-transform: uppercase; text-shadow: 3px 3px 0 #000; }
        h2 { font-size: 10px; color: #ffff55; margin: 5px 0 20px 0; border-bottom: 2px dashed #444; padding-bottom: 10px; }
        .stat-box { background: rgba(255,255,255,0.05); padding: 15px; margin-bottom: 15px; border: 2px solid #333; }
        .label { color: #aaa; font-size: 10px; margin-bottom: 5px; display: block; }
        .value { color: #fff; font-size: 12px; }
        .farming-box { margin-top: auto; border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 15px; font-size: 10px; color: #2ecc71; line-height: 1.6; }
    </style>
</head>
<body>

<div id="cursor-layer"><div class="crosshair"></div></div>
<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">[X]</div>
    <div class="sidebar-image-container"><img id="sb-image" src="" class="sidebar-img"></div>
    <h1 id="sb-title">Scanning...</h1>
    <h2 id="sb-chinese">...</h2>
    <div class="stat-box"><span class="label">TEMPERATURE</span><span class="value" id="sb-temp">--</span></div>
    <div class="stat-box"><span class="label">CONDITION</span><span class="value" id="sb-cond">--</span></div>
    <div class="farming-box" id="sb-farm">Click the map to scan a biome.</div>
</div>

<script>
    // --- 1. SETUP ---
    // Access keys from config.js
    const MAPBOX_KEY = config.MAPBOX_KEY;
    const WEATHER_KEY = config.WEATHER_KEY;

    mapboxgl.accessToken = MAPBOX_KEY;

    // --- 2. MAP INITIALIZATION ---
    // We removed 'projection: globe' to fix the black screen issue.
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9', // Needed for water detection
        center: [105.0, 40.0],
        zoom: 3,
        projection: 'globe'
    });

    // --- 3. BIOME LOGIC ---
    function determineBiome(temp, humidity, weatherMain, isWater) {
        
        // Ocean Logic
        if (isWater) {
            if (temp < -2) return { name: "Frozen Ocean", chinese: "å†»æ´‹ (DÃ²ng YÃ¡ng)", farm: "â„ï¸ Ice mining.", image: "images/snowytundra.png" };
            if (temp < 20) return { name: "Cold Ocean", chinese: "å†·æ°´æµ·æ´‹ (LÄ›ngshuÇ)", farm: "ðŸŸ Cod & Salmon.", image: "images/swamp.png" };
            return { name: "Warm Ocean", chinese: "æš–æ°´æµ·æ´‹ (NuÇŽnshuÇ)", farm: "ðŸ¡ Pufferfish & Coral.", image: "images/plains.png" };
        }

        // Land Logic
        if (temp < -5) return { name: "Snowy Tundra", chinese: "å†»åŽŸ (DÃ²ngyuÃ¡n)", farm: "Ice mining only.", image: "images/snowytundra.png" };
        if (temp >= -5 && temp < 10) return { name: "Taiga", chinese: "é’ˆå¶æž— (ZhÄ“nyÃ¨lÃ­n)", farm: "Spruce & Berries.", image: "images/taiga.png" };
        
        if (temp >= 10 && temp < 20) {
            if (humidity > 80) return { name: "Swamp", chinese: "æ²¼æ³½ (ZhÇŽozÃ©)", farm: "Slimes & Mushrooms.", image: "images/swamp.png" };
            return { name: "Plains", chinese: "å¹³åŽŸ (PÃ­ngyuÃ¡n)", farm: "Great for Wheat!", image: "images/plains.png" };
        }

        if (temp >= 20) {
            // Using forest.png for Jungle fallback
            if (humidity > 60) return { name: "Jungle", chinese: "ä¸›æž— (CÃ³nglÃ­n)", farm: "Bamboo & Melons.", image: "images/forest.png" };
            if (humidity < 40) return { name: "Desert", chinese: "æ²™æ¼  (ShÄmÃ²)", farm: "Cactus only.", image: "images/desert.png" };
            return { name: "Savanna", chinese: "çƒ­å¸¦è‰åŽŸ (RÃ¨dÃ i)", farm: "Acacia trees.", image: "images/savanna.png" };
        }

        return { name: "Forest", chinese: "æ£®æž— (SÄ“nlÃ­n)", farm: "Apples & Oak.", image: "images/forest.png" };
    }

    // --- 4. CLICK INTERACTION ---
    map.on('click', async (e) => {
        const { lng, lat } = e.lngLat;
        const sidebar = document.getElementById('sidebar');

        // Check for Water (Safe Check)
        let isWater = false;
        try {
            const features = map.queryRenderedFeatures(e.point);
            isWater = features.some(f => f.layer.id.includes('water'));
        } catch (err) {
            console.log("Water check failed, assuming land.");
        }

        try {
            const response = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${WEATHER_KEY}`);
            const data = await response.json();

            if (data.cod !== 200) {
                alert("Weather API Error: " + data.message);
                return;
            }

            const temp = data.main.temp;
            const humidity = data.main.humidity;
            const weatherMain = data.weather[0].main;
            const biome = determineBiome(temp, humidity, weatherMain, isWater);

            document.getElementById('sb-image').src = biome.image;
            document.getElementById('sb-title').innerText = biome.name;
            document.getElementById('sb-chinese').innerText = biome.chinese;
            document.getElementById('sb-temp').innerText = Math.round(temp) + "Â°C";
            document.getElementById('sb-cond').innerText = weatherMain + (isWater ? " (Water)" : "");
            document.getElementById('sb-farm').innerText = biome.farm;

            sidebar.classList.add('active');

        } catch (err) {
            console.error(err);
        }
    });

    function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }

    document.addEventListener('mousemove', (e) => {
        const cursor = document.getElementById('cursor-layer');
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
    });
</script>

</body>
</html>