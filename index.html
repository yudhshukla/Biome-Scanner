<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Minecraft Biome Scanner</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }
        
        #map { cursor: none; width: 100%; height: 100%; position: absolute; }
        #cursor-layer { position: fixed; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .crosshair { width: 24px; height: 24px; position: relative; transform: translate(-50%, -50%); }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 2px black; }
        .crosshair::before { top: 11px; left: 0; width: 24px; height: 2px; }
        .crosshair::after { top: 0; left: 11px; width: 2px; height: 24px; }

        .steve-marker {
            width: 25px; height: 50px;
            background-image: url('images/steve.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            image-rendering: pixelated; 
        }
        /* --- PASSPORT / UI UPDATES --- */
        .passport-container {
            position: absolute; top: 20px; left: 20px;
            background: rgba(0, 0, 0, 0.85); border: 2px solid #f1c40f;
            padding: 15px; color: white; z-index: 10;
            box-shadow: 0 0 10px #f1c40f;
            font-family: 'Press Start 2P', cursive;
        }
        .passport-title { font-size: 10px; color: #aaa; margin-bottom: 5px; }
        .passport-score { font-size: 16px; color: #f1c40f; text-shadow: 2px 2px 0 #000; }
        
        /* --- Scoreboard --- */
        .score {
            position: absolute; 
            top: 20px; 
            right: 20px; 
            
            background: rgba(0, 0, 0, 0.85); 
            border: 2px solid #f1c40f; 
            padding: 15px; 
            
            z-index: 10; /* Put on top of map */
            font-family: 'Press Start 2P', cursive;
            text-align: center;
            box-shadow: 0 0 10px #f1c40f;
        }

        .score-label {
            font-size: 10px;
            color: #aaa;
            margin-bottom: 5px;
        }

        .score-value {
            font-size: 24px; 
            color: #2ecc71; 
            text-shadow: 2px 2px 0 #000;
        }

        /* ACHIEVEMENT POPUP */
        .achievement-popup {
            position: fixed; top: -100px; left: 50%; transform: translateX(-50%);
            background: linear-gradient(180deg, #2ecc71, #27ae60);
            border: 4px solid #fff; padding: 20px 40px;
            color: white; text-align: center; z-index: 99999;
            box-shadow: 0 10px 0 rgba(0,0,0,0.5);
            transition: top 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55);
            pointer-events: none;
        }
        .achievement-popup.show { top: 50px; }
        .ach-title { font-size: 12px; color: #e8f5e9; margin-bottom: 10px; }
        .ach-name { font-size: 20px; font-weight: bold; text-shadow: 3px 3px 0 #000; }
        #sidebar {
            position: absolute; top: 0; right: -550px; width: 500px; height: 100%;
            background: rgba(16, 0, 16, 0.95); border-left: 6px solid #28022e;
            box-shadow: -10px 0 20px rgba(0,0,0,0.8); transition: right 0.3s ease-in-out;
            z-index: 100; padding: 30px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        #sidebar.active { right: 0; }
        
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #ff5555; }
        
        .header-container { display: flex; align-items: center; margin-bottom: 25px; border-bottom: 2px dashed #444; padding-bottom: 20px; }
        .country-flag { width: 80px; height: 50px; border: 3px solid #fff; margin-right: 20px; box-shadow: 4px 4px 0 #000; }
        .country-info { display: flex; flex-direction: column; }
        .country-name { font-size: 16px; color: #ffff55; line-height: 1.5; text-transform: uppercase; margin-bottom: 5px; }
        .region-name { font-size: 10px; color: #aaa; text-transform: uppercase; }

        .sidebar-image-container { width: 100%; height: 250px; border: 4px solid #555; margin-bottom: 25px; background: #000; position: relative; }
        .sidebar-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }

        h1 { font-size: 24px; color: #fff; margin: 0; text-transform: uppercase; text-shadow: 3px 3px 0 #000; margin-bottom: 12px; line-height: 1.4; }
        h2 { font-family: 'Noto Sans SC', sans-serif; font-size: 20px; color: #f1c40f; margin: 0 0 25px 0; border-bottom: 2px dashed #444; padding-bottom: 20px; letter-spacing: 1px; }
        
        /* --- UPDATED UNIFORM GRID --- */
        .stat-grid { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); /* Forces 3 equal columns */
            gap: 12px; 
            margin-bottom: 30px; 
            width: 100%;
        }
        .stat-box { 
            background: rgba(255,255,255,0.08); 
            padding: 10px; 
            border: 3px solid #333; 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            text-align: center; 
            
            /* KEY FIXES FOR UNIFORMITY */
            width: 100%;
            height: 70px; /* Fixed height ensures they line up */
            box-sizing: border-box; /* Keeps padding inside the box */
        }
        .label { color: #aaa; font-size: 9px; margin-bottom: 8px; display: block; letter-spacing: 1px; text-transform: uppercase; }
        .value { color: #fff; font-size: 13px; font-weight: bold; text-shadow: 2px 2px 0 #000; white-space: nowrap; }

        /* MOBS */
        .mob-list { margin-bottom: 20px; }
        .mob-title { font-size: 12px; color: #aaa; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 6px; letter-spacing: 1px;}
        .mobs { font-size: 16px; color: #2ecc71; line-height: 1.8; text-shadow: 1px 1px 0 #000; }

        #game-modal {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            /* Cover the whole screen */

            background: rgba(0, 0, 0, 0.95); 
            z-index: 100000; 
            display: none; 
            text-align: center; 
            color: white;
        }
        #street-view-container {
            width: 80%;
            height: 60%;
            margin: 50px auto;
            border: 4px solid #f1c40f;
        }

        #guess-buttons { 
            display: grid; 
            grid-template-columns: repeat(2, 1fr); /* Modeled off stat-grid to create 2 equal columns */
            gap: 15px; 
            width: 80%;
            margin: 20px auto 0 auto; 
        }

        .guess-btn {
            /* Styles modeled off stat-box */
            background: rgba(255, 255, 255, 0.08); 
            border: 3px solid #333; 
            
            color: #fff; 
            font-family: 'Press Start 2P', cursive;
            font-size: 11px; 
            line-height: 1.5;
            text-shadow: 2px 2px 0 #000; 
            
            padding: 15px; 
            height: 70px;
            box-sizing: border-box; 
            
            transition: all 0.2s; /* Makes animations smooth */
        }

        .guess-btn:hover {
            background: rgba(255, 255, 255, 0.2); 
            border-color: #f1c40f; 
            transform: scale(1.05); /* Make the button pop out slightly when hovering */
        }

    </style>
</head>
<body>

<div class="passport-container">
    <div class="passport-title">BIOMES DISCOVERED</div>
    <div class="passport-score" id="biome-score-display">0 / 0</div>
</div>

<div class="score">
    <div class="score-label">SCORE </div>
    <div class="score-value" id="score-display">0</div>
</div>"

<div id="achievement-box" class="achievement-popup">
    <div class="ach-title"> NEW DISCOVERY! </div>
    <div class="ach-name" id="ach-biome-name">PLAINS</div>
</div>

<div id="cursor-layer"><div class="crosshair"></div></div>
<div id="map"></div>


<div id="game-modal" class="hidden">
    <h2>GUESS THE BIOME!</h2>
    <div id="street-view-container"></div> <!-- Frame to paint street view -->
    <div id="guess-buttons">
        <!-- When clicked, call makeGuess with the text on the button-->
        <button id="btn-0" class="guess-btn" onclick="makeGuess(this.innerText)"></button>
        <button id="btn-1" class="guess-btn" onclick="makeGuess(this.innerText)"></button>
        <button id="btn-2" class="guess-btn" onclick="makeGuess(this.innerText)"></button>
        <button id="btn-3" class="guess-btn" onclick="makeGuess(this.innerText)"></button>
    </div>
    
</div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">[X]</div>
    
    <div class="header-container">
        <img id="sb-flag" class="country-flag" src="" style="display:none;">
        <div class="country-info">
            <div id="sb-country" class="country-name">Scanning...</div>
            <div id="sb-region" class="region-name">...</div>
        </div>
    </div>

    <div class="sidebar-image-container"><img id="sb-image" src="" class="sidebar-img"></div>
    
    <h1 id="sb-biome">Unknown</h1>
    <h2 id="sb-chinese">...</h2>
    
    <div class="stat-grid">
        <div class="stat-box"><span class="label">TEMP</span><span class="value" id="sb-temp">--</span></div>
        <div class="stat-box"><span class="label">TIME</span><span class="value" id="sb-time">--</span></div>
        <div class="stat-box"><span class="label">ELEV</span><span class="value" id="sb-elev">--</span></div>
        <div class="stat-box"><span class="label">PRECIPITATION</span><span class="value" id="sb-precip">--</span></div>
        <div class="stat-box"><span class="label">HUMIDITY</span><span class="value" id="sb-hum">--</span></div>
        <div class="stat-box"><span class="label">COORDS</span><span class="value" id="sb-coords">--</span></div>
    </div>

    <div class="mob-list">
        <div class="mob-title">LIKELY MOBS</div>
        <div class="mobs" id="sb-mobs">--</div>
    </div>
</div>

<script>
    let map;
    let steveMarker = null;
    let svService = null;
    let currentCorrectBiome = null;
    let gameScore = 0;
    let streak = 1;

    // --- BIOME DATA ---
    const BIOME_DATA = {
        'Badlands': { chinese: 'æ¶åœ° ÃˆdÃ¬', image: 'images/badlands.png', mobs: 'Spiders (Night)' },
        'Desert': { chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', mobs: 'Husks, Rabbits' },
        'Mangrove Swamp': { chinese: 'çº¢æ ‘æž—æ²¼æ³½ HÃ³ng ShÃ¹lÃ­n ZhÇŽozÃ©', image: 'images/mangroveswamp.png', mobs: 'Warm Frogs, Slimes' },
        'Swamp': { chinese: 'æ²¼æ³½ ZhÇŽozÃ©', image: 'images/swamp.png', mobs: 'Slimes, Witches' },
        'Snowy Taiga': { chinese: 'ç§¯é›ªé’ˆå¶æž— JÄ«xuÄ› ZhÄ“nyÃ¨lÃ­n', image: 'images/snowytaiga.png', mobs: 'Foxes (White), Wolves' },
        'Tropical Jungle': { chinese: 'çƒ­å¸¦ä¸›æž— RÃ¨dÃ i CÃ³nglÃ­n', image: 'images/tropicaljungle.png', mobs: 'Ocelots, Parrots' },
        'Snowy Tundra': { chinese: 'å†»åŽŸ DÃ²ngyuÃ¡n', image: 'images/snowytundra.png', mobs: 'Strays, Polar Bears' },
        'Sparse Jungle': { chinese: 'ç¨€ç–ä¸›æž— XÄ«shÅ« CÃ³nglÃ­n', image: 'images/sparsejungle.png', mobs: 'Pandas, Parrots' },
        'Bamboo Jungle': { chinese: 'ç«¹æž— ZhÃºlÃ­n', image: 'images/bamboojungle.png', mobs: 'Pandas' },
        'Jungle': { chinese: 'ä¸›æž— CÃ³nglÃ­n', image: 'images/jungle.png', mobs: 'Ocelots, Parrots' },
        'Cherry Grove': { chinese: 'æ¨±èŠ±æ ‘æž— YÄ«nghuÄ ShÃ¹lÃ­n', image: 'images/cherrygrove.png', mobs: 'Bees, Sheep' },
        'Basalt Deltas': { chinese: 'çŽ„æ­¦å²©ä¸‰è§’æ´² XuÃ¡nwÇ”yÃ¡n SÄnjiÇŽozhÅu', image: 'images/basaltdeltas.png', mobs: 'Magma Cubes' },
        'Mushroom Fields': { chinese: 'è˜‘è‡å²› MÃ³gÅ« DÇŽo', image: 'images/mushroomfields.png', mobs: 'Mooshrooms' },
        'Jagged Peaks': { chinese: 'å°–å³­å±±å³° JiÄnqiÃ o ShÄnfÄ“ng', image: 'images/jaggedpeaks.png', mobs: 'Goats' },
        'Ice Spikes': { chinese: 'å†°åˆº BÄ«ng CÃ¬', image: 'images/icespikes.png', mobs: 'Polar Bears' },
        'Taiga': { chinese: 'é’ˆå¶æž— ZhÄ“nyÃ¨lÃ­n', image: 'images/taiga.png', mobs: 'Foxes, Wolves' },
        'Old Growth Taiga': { chinese: 'åŽŸç”Ÿé’ˆå¶æž— YuÃ¡nshÄ“ng ZhÄ“n YÃ¨ LÃ­n', image: 'images/oldgrowthtaiga.png', mobs: 'Wolves' },
        'Birch Forest': { chinese: 'ç™½æ¡¦æ£®æž— BÃ¡ihuÃ  SÄ“nlÃ­n', image: 'images/birchforest.png', mobs: 'Cows, Sheep' },
        'Savanna': { chinese: 'çƒ­å¸¦è‰åŽŸ RÃ¨dÃ i CÇŽoyuÃ¡n', image: 'images/savanna.png', mobs: 'Llamas, Horses' },
        'Savanna Plateau': { chinese: 'çƒ­å¸¦é«˜åŽŸ RÃ¨dÃ i GÄoyuÃ¡n', image: 'images/savannaplateau.png', mobs: 'Llamas' },
        'Plains': { chinese: 'å¹³åŽŸ PÃ­ngyuÃ¡n', image: 'images/plains.png', mobs: 'Horses, Donkeys' },
        'River': { chinese: 'æ²³æµ HÃ©liÃº', image: 'images/river.png', mobs: 'Drowned (Night)' },
        'Stony Peaks': { chinese: 'çŸ³å³° ShÃ­fÄ“ng', image: 'images/stonypeaks.png', mobs: 'Goats' },
        
        // OCEAN VARIANTS
        'Deep Ocean': { chinese: 'æ·±æµ· ShÄ“nhÇŽi', image: 'images/deepocean.png', mobs: 'Guardians' },
       // 'Frozen Ocean': { chinese: 'å†»æ´‹ DÃ²ng YÃ¡ng', image: 'images/frozenocean.png', mobs: 'Polar Bears' },
        'Deep Frozen Ocean': { chinese: 'æ·±å†»æ´‹ ShÄ“n DÃ²ngyÃ¡ng', image: 'images/deepfrozenocean.png', mobs: 'Polar Bears' },
       // 'Cold Ocean': { chinese: 'å†·æ°´æµ·æ´‹ LÄ›ngshuÇ HÇŽiyÃ¡ng', image: 'images/coldocean.png', mobs: 'Salmon, Dolphins' },
        'Deep Cold Ocean': { chinese: 'æ·±å†·æ°´æµ·æ´‹ ShÄ“n LÄ›ngshuÇ HÇŽiyÃ¡ng', image: 'images/coldocean.png', mobs: 'Salmon' },
      //  'Lukewarm Ocean': { chinese: 'æ¸©æ°´æµ·æ´‹ WÄ“nshu HÇŽiyÃ¡ng', image: 'images/lukewarmocean.png', mobs: 'Pufferfish' },
        'Deep Lukewarm Ocean': { chinese: 'æ·±æ¸©æ°´æµ·æ´‹ ShÄ“n WÄ“nshuÇ HÇŽiyÃ¡ng', image: 'images/deeplukewarmocean.png', mobs: 'Pufferfish' },
      //  'Warm Ocean': { chinese: 'æš–æ°´æµ·æ´‹ NuÇŽnshuÇ HÇŽiyÃ¡ng', image: 'images/warmocean.png', mobs: 'Tropical Fish' }
    };

    const REGION_MAP = {
        'California': 'Badlands', 'Nevada': 'Desert', 'Arizona': 'Desert', 'Florida': 'Mangrove Swamp', 'Louisiana': 'Swamp', 'Alaska': 'Snowy Taiga', 'Hawaii': 'Tropical Jungle', 'Yukon': 'Snowy Tundra', 'Siberia': 'Snowy Taiga'
    };
    const COUNTRY_MAP = {
        'SA': 'Desert', 'EG': 'Desert', 'AE': 'Desert', 'OM': 'Badlands', 'BR': 'Sparse Jungle', 'ID': 'Bamboo Jungle', 'VN': 'Jungle', 'JP': 'Cherry Grove', 'IS': 'Basalt Deltas', 'MG': 'Mushroom Fields', 'NP': 'Jagged Peaks', 'GL': 'Ice Spikes', 'AQ': 'Ice Spikes', 'RU': 'Snowy Taiga', 'CA': 'Taiga'
    };

    // --- LOGIC FUNCTIONS ---
    // --- PASSPORT SYSTEM ---
    const TOTAL_BIOMES = Object.keys(BIOME_DATA).length;
    let discoveredBiomes = JSON.parse(localStorage.getItem('myBiomes')) || [];

    function updateScore() {
        const count = discoveredBiomes.length;
        document.getElementById('biome-score-display').innerText = `${count} / ${TOTAL_BIOMES}`;
    }
    // Run once on load
    updateScore();

    function triggerAchievement(biomeName) {
    const popup = document.getElementById('achievement-box');
    const nameEl = document.getElementById('ach-biome-name');
    
    // Play Sound (Optional - create an Audio object if you want)
    // new Audio('levelup.mp3').play();

    nameEl.innerText = biomeName;
    popup.classList.add('show');

    // Hide after 3 seconds
    setTimeout(() => {
        popup.classList.remove('show');
    }, 3000);
}

    function getOceanBiome(temp, isDeep) {
        let prefix = isDeep ? "Deep " : "";
        if (temp < -2) return isDeep ? 'Deep Frozen Ocean' : 'Frozen Ocean';
        if (temp < 10) return isDeep ? 'Deep Cold Ocean' : 'Cold Ocean';
        if (temp < 25) return isDeep ? 'Deep Ocean' : 'Ocean';
        if (temp < 30) return isDeep ? 'Deep Lukewarm Ocean' : 'Lukewarm Ocean';
        return 'Warm Ocean';
    }

    function getBiomeByLat(lat, humidity, elevation) {
        const abs = Math.abs(lat);
        if (abs > 60) return 'Snowy Tundra';
        if (abs > 50) return (humidity > 60) ? 'Old Growth Taiga' : 'Taiga';
        if (abs > 35) return (humidity > 70) ? 'Birch Forest' : 'Plains';
        if (abs > 23) {
            if (humidity > 70) return 'Mangrove Swamp';
            if (humidity < 30) return 'Desert';
            return (elevation > 1000) ? 'Savanna Plateau' : 'Savanna';
        }
        if (abs >= 0) {
            if (humidity > 80) return 'Bamboo Jungle';
            if (humidity > 50) return 'Jungle';
            if (humidity < 40) return 'Sparse Jungle';
            return 'Jungle';
        }
        return 'Plains';
    }

    // --- INIT ---
    async function init() {
        try {
            const res = await fetch('https://minecraft-biome-scanner.onrender.com/api/config');
            const data = await res.json();
            mapboxgl.accessToken = data.mapboxKey;
            // Google Maps requires API keys to be built directly into the URL of the script tag
            // So, create an empty script element 
            const googleScript = document.createElement('script');
            
            // Inject the API key into the URL
            googleScript.src = `https://maps.googleapis.com/maps/api/js?key=${data.googleKey}`;
            googleScript.async = true; // Load asynchronously 
            
            // Inject the script into <head> to start loading Google Maps API
            document.head.appendChild(googleScript);

            googleScript.onload = () => {
                // Now it is safe to create the service
                svService = new google.maps.StreetViewService();
                console.log("Google Maps loaded successfully!");
            };

            map = new mapboxgl.Map({
                container: 'map',
                style: 'mapbox://styles/mapbox/satellite-v9',
                center: [30.0, 20.0], 
                zoom: 2.5,
                projection: 'globe' 
            });

            map.on('style.load', () => {
                map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
                map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
                map.setFog({ 'color': 'rgb(10, 10, 20)', 'high-color': 'rgb(30, 30, 50)', 'horizon-blend': 0.1, 'star-intensity': 0.6 });
            });

            map.on('click', handleMapClick);

            document.addEventListener('mousemove', (e) => {
                const cursor = document.getElementById('cursor-layer');
                cursor.style.left = e.clientX + 'px';
                cursor.style.top = e.clientY + 'px';
            });

        } catch (err) {
            console.error("Error connecting to backend:", err);
            alert("Backend error. Make sure app.py is running!");
        }
    }

    // --- CLICK HANDLER ---
    // --- CLICK HANDLER ---
    async function handleMapClick(e) {
        closeSidebar(); 

        const { lng, lat } = e.lngLat;
        const sidebar = document.getElementById('sidebar');

        if (steveMarker) steveMarker.remove();
        const el = document.createElement('div');
        el.className = 'steve-marker';
        steveMarker = new mapboxgl.Marker(el).setLngLat(e.lngLat).addTo(map);

        const elevation = map.queryTerrainElevation(e.lngLat) || 0;

        let geoData = { countryCode: null, countryName: null, regionName: null };
        let weatherData = { main: { temp: 20, humidity: 50 }, weather: [{ main: 'Clear' }], timezone: 0 };
        
        try {
            const res = await fetch(`https://minecraft-biome-scanner.onrender.com/api/scan?lat=${lat}&lng=${lng}`);
            if (res.ok) {
                // We use 'apiData' here to avoid naming conflicts
                const apiData = await res.json();
                if (apiData.geo) geoData = apiData.geo;
                if (apiData.weather) weatherData = apiData.weather;
            }
        } catch (e) { console.warn("Backend Scan Failed, using defaults"); }

        const temp = Math.round(weatherData.main.temp);
        const humidity = weatherData.main.humidity;
        const weatherMain = weatherData.weather[0].main;
        const hours = new Date().getHours(); 
        const isNight = hours < 6 || hours > 18;
        const timeString = isNight ? "NIGHT" : "DAY";

        let biomeKey = "Plains";
        const countryCode = geoData.countryCode; 
        const regionName = geoData.regionName; 
        const isDeepOcean = !countryCode;

        // 1. Determine Biome Key
        if (isDeepOcean) {
            if (lat < -60 && elevation > 10) biomeKey = 'Ice Spikes'; 
            else biomeKey = getOceanBiome(temp, isDeepOcean);
        }
        else if (elevation > 2000) {
            let snowLine = Math.abs(lat) < 30 ? 4000 : 1500;
            biomeKey = (elevation > snowLine) ? 'Jagged Peaks' : 'Stony Peaks';
        }
        else if (REGION_MAP[regionName]) biomeKey = REGION_MAP[regionName];
        else if (COUNTRY_MAP[countryCode]) biomeKey = COUNTRY_MAP[countryCode];
        else biomeKey = getBiomeByLat(lat, humidity, elevation); 

        // 2. Validate Biome Key
        if (!BIOME_DATA[biomeKey]) biomeKey = 'Plains';
        
        // 3. PASSPORT SYSTEM: Check for Discovery
        if (!discoveredBiomes.includes(biomeKey)) {
            // It's new! Save it.
            discoveredBiomes.push(biomeKey);
            localStorage.setItem('myBiomes', JSON.stringify(discoveredBiomes));
            
            // Trigger the "Level Up" event
            updateScore();
            triggerAchievement(biomeKey.toUpperCase());
        }

        // 4. Get Data for UI (Declared ONLY ONCE now)
        const data = BIOME_DATA[biomeKey];

        // 5. Render UI
        let displayName = geoData.countryName || "Deep Ocean";
        if (lat < -60 && elevation > 10) displayName = "Antarctica";

        document.getElementById('sb-country').innerText = displayName;
        document.getElementById('sb-region').innerText = regionName || "";
        
        const flagImg = document.getElementById('sb-flag');
        if (countryCode) {
            flagImg.src = `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
            flagImg.style.display = 'block';
        } else {
            flagImg.style.display = 'none';
        }

        document.getElementById('sb-biome').innerText = biomeKey;
        document.getElementById('sb-chinese').innerText = data.chinese;
        document.getElementById('sb-image').src = data.image;
        document.getElementById('sb-mobs').innerText = data.mobs;

        document.getElementById('sb-temp').innerText = temp + "Â°C";
        
        let safeElev = Math.round(elevation);
        if (safeElev < 0) safeElev = 0; 
        document.getElementById('sb-elev').innerText = safeElev + "m";

        document.getElementById('sb-hum').innerText = humidity + "%";
        document.getElementById('sb-time').innerText = timeString;
        document.getElementById('sb-coords').innerText = `${lat.toFixed(1)}, ${lng.toFixed(1)}`;
        
        let precipText = "NONE";
        if (weatherMain === "Rain" || weatherMain === "Drizzle") precipText = "RAIN ðŸŒ§ï¸";
        if (weatherMain === "Snow") precipText = "SNOW â„ï¸";
        if (weatherMain === "Thunderstorm") precipText = "STORM â›ˆï¸";
        document.getElementById('sb-precip').innerText = precipText;

        // Check if the google maps service exists before trying to access attributes 
        if (svService) {
            svService.getPanorama({ location: { lat: lat, lng: lng }, radius: 50 }, (data, status) => {
                if (status === "OK") { //if it exists, and there is a street view where we clicked
                    document.getElementById('game-modal').style.display = 'block'; // Unhide the modal
                    // Image should be painted in the street view container, and it should paint the coords we clicked on 
                    new google.maps.StreetViewPanorama(document.getElementById('street-view-container'),{
                        position: data.location.latLng // The data we get back is a dictionary with a 'location' key, which has a 'latLng' key, which is the coordinates of the street view panorama
                    });
                    
                    // Populate array with the correct answer and 3 random wrong answers
                    currentCorrectBiome = biomeKey;
                    let options = [biomeKey];
                    while (options.length < 4) {
                        const randIndex = Math.floor(Math.random() * Object.keys(BIOME_DATA).length); // Choose random biome
                        const randBiome = Object.keys(BIOME_DATA)[randIndex];
                        if (!options.includes(randBiome)) { // Don't add the biome if it's already in options
                            options.push(randBiome);
                        }
                    }
                    // Found online trick to shuffle array
                    options.sort(() => Math.random() - 0.5);

                    // Write options to buttons
                    for (let i = 0; i < 4; i ++){
                        const btn = document.getElementById(`btn-${i}`);
                        btn.innerText = options[i];
                        btn.style.display = 'inline-block'; // Make buttons visible
                    }
                    
                    console.log("STREET VIEW FOUND at:", data.location.latLng.toString());
                } else {
                    sidebar.classList.add('active');
                    console.log("No Street View available here.");
                }
            });
        } else {
            sidebar.classList.add('active');
            console.warn("Google Maps is still loading...");
        }
    }

    init();

    function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }

    function makeGuess(guess) {
        if (guess === currentCorrectBiome) {
            alert("You guessed the biome!!!");
            gameScore += 100 * (streak * 1.25) * (discoveredBiomes.includes(currentCorrectBiome) ? 1 : 2); // More points for new biomes with a streak multiplier
            document.getElementById('score-display').innerText = gameScore;
            streak += 1;
        } else {
            alert(`The correct biome was '${currentCorrectBiome}'`);
            streak = 1;
        }
        document.getElementById('game-modal').style.display = 'none'; // Hide the modal after guessing
        document.getElementById('sidebar').classList.add('active'); // Open the sidebar with the biome info when the game modal closes
    }
</script>

</body>
</html>