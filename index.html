<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Minecraft Atlas Scanner</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }
        
        /* Cursor (Hidden to allow Steve Marker to be the focus, or keep crosshair?) 
           Let's keep crosshair for aiming, Steve for marking. */
        #map { cursor: none; width: 100%; height: 100%; position: absolute; }
        #cursor-layer { position: fixed; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .crosshair { width: 24px; height: 24px; position: relative; transform: translate(-50%, -50%); }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 2px black; }
        .crosshair::before { top: 11px; left: 0; width: 24px; height: 2px; }
        .crosshair::after { top: 0; left: 11px; width: 2px; height: 24px; }

        /* --- STEVE MARKER --- */
        .steve-marker {
            width: 40px;
            height: 40px;
            background-image: "images/steve.png";
            background-size: cover;
            border: 2px solid white;
            box-shadow: 4px 4px 0 #000;
            image-rendering: pixelated;
        }

        /* Sidebar */
        #sidebar {
            position: absolute; top: 0; right: -600px; width: 550px; height: 100%;
            background: rgba(16, 0, 16, 0.95); border-left: 6px solid #28022e;
            box-shadow: -10px 0 20px rgba(0,0,0,0.8); transition: right 0.3s ease-in-out;
            z-index: 100; padding: 30px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column;
        }
        #sidebar.active { right: 0; }
        
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #ff5555; }
        
        /* Header */
        .header-container { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px dashed #444; padding-bottom: 15px; }
        .country-flag { width: 80px; height: 50px; border: 3px solid #fff; margin-right: 20px; box-shadow: 4px 4px 0 #000; }
        .country-info { display: flex; flex-direction: column; }
        .country-name { font-size: 16px; color: #ffff55; line-height: 1.5; text-transform: uppercase; margin-bottom: 5px; }
        .region-name { font-size: 10px; color: #aaa; text-transform: uppercase; }

        /* Biome Image */
        .sidebar-image-container { width: 100%; height: 220px; border: 4px solid #555; margin-bottom: 15px; background: #000; position: relative; }
        .sidebar-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }

        h1 { font-size: 20px; color: #fff; margin: 0; text-transform: uppercase; text-shadow: 3px 3px 0 #000; margin-bottom: 10px; line-height: 1.4; }
        h2 { font-family: 'Noto Sans SC', sans-serif; font-size: 18px; color: #f1c40f; margin: 0 0 20px 0; border-bottom: 2px dashed #444; padding-bottom: 15px; letter-spacing: 1px; }
        
        /* Stats Grid */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.08); padding: 15px; border: 3px solid #333; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .label { color: #aaa; font-size: 10px; margin-bottom: 8px; display: block; letter-spacing: 1px; }
        .value { color: #fff; font-size: 12px; font-weight: bold; text-shadow: 2px 2px 0 #000; }

        .farming-box { margin-top: auto; border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 20px; font-size: 12px; color: #2ecc71; line-height: 1.6; }
    </style>
</head>
<body>

<div id="cursor-layer"><div class="crosshair"></div></div>
<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">[X]</div>
    
    <div class="header-container">
        <img id="sb-flag" class="country-flag" src="" style="display:none;">
        <div class="country-info">
            <div id="sb-country" class="country-name">Scanning...</div>
            <div id="sb-region" class="region-name">...</div>
        </div>
    </div>

    <div class="sidebar-image-container"><img id="sb-image" src="" class="sidebar-img"></div>
    
    <h1 id="sb-biome">Unknown</h1>
    <h2 id="sb-chinese">...</h2>
    
    <div class="stat-grid">
        <div class="stat-box"><span class="label">TEMP</span><span class="value" id="sb-temp">--</span></div>
        <div class="stat-box"><span class="label">ELEVATION</span><span class="value" id="sb-elev">--</span></div>
        <div class="stat-box"><span class="label">PRECIPITATION</span><span class="value" id="sb-precip">--</span></div>
        <div class="stat-box"><span class="label">HUMIDITY</span><span class="value" id="sb-hum">--</span></div>
    </div>

    <div class="farming-box" id="sb-farm">Click a location to scan.</div>
</div>

<script>
    const MAPBOX_KEY = config.MAPBOX_KEY;
    const WEATHER_KEY = config.WEATHER_KEY;

    mapboxgl.accessToken = MAPBOX_KEY;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12', 
        center: [30.0, 20.0], 
        zoom: 2.5,
        projection: 'globe' 
    });

    // Steve Marker Variable
    let steveMarker = null;

    map.on('style.load', () => {
        map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
        map.setFog({ 'color': 'rgb(10, 10, 20)', 'high-color': 'rgb(30, 30, 50)', 'horizon-blend': 0.1, 'star-intensity': 0.6 });
    });

    // --- BIOME DICTIONARIES ---
    const REGION_BIOMES = {
        'California': { biome: 'Badlands', chinese: 'æ¶åœ° ÃˆdÃ¬', image: 'images/desert.png', farm: 'â›ï¸ Gold Mines.' },
        'Nevada': { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Cactus.' },
        'Arizona': { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Cactus.' },
        'Florida': { biome: 'Mangrove Swamp', chinese: 'çº¢æ ‘æ— HÃ³ngshÃ¹lÃ­n', image: 'images/swamp.png', farm: 'ğŸ¸ Frogs.' },
        'Louisiana': { biome: 'Swamp', chinese: 'æ²¼æ³½ ZhÇozÃ©', image: 'images/swamp.png', farm: 'ğŸ„ Slimes.' },
        'Alaska': { biome: 'Snowy Taiga', chinese: 'ç§¯é›ªé’ˆå¶æ— JÄ«xuÄ› ZhÄ“nyÃ¨lÃ­n', image: 'images/taiga.png', farm: 'ğŸŒ² Foxes.' },
        'Hawaii': { biome: 'Tropical Jungle', chinese: 'çƒ­å¸¦ä¸›æ— RÃ¨dÃ i CÃ³nglÃ­n', image: 'images/forest.png', farm: 'ğŸ¥¥ Coconuts.' },
        'Yukon': { biome: 'Snowy Tundra', chinese: 'å†»åŸ DÃ²ngyuÃ¡n', image: 'images/snowytundra.png', farm: 'â„ï¸ Polar Bears.' },
        'Siberia': { biome: 'Snowy Taiga', chinese: 'ç§¯é›ªé’ˆå¶æ— JÄ«xuÄ› ZhÄ“nyÃ¨lÃ­n', image: 'images/taiga.png', farm: 'ğŸŒ² Spruce.' }
    };

    const COUNTRY_BIOMES = {
        'SA': { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Cactus & Oil.' }, 
        'EG': { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Sugar Cane.' },
        'AE': { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Cactus.' },
        'OM': { biome: 'Badlands', chinese: 'æ¶åœ° ÃˆdÃ¬', image: 'images/desert.png', farm: 'â›ï¸ Gold.' },
        'BR': { biome: 'Sparse Jungle', chinese: 'ç¨€ç–ä¸›æ— XÄ«shÅ« CÃ³nglÃ­n', image: 'images/forest.png', farm: 'ğŸ‹ Bamboo.' },
        'ID': { biome: 'Bamboo Jungle', chinese: 'ç«¹æ— ZhÃºlÃ­n', image: 'images/forest.png', farm: 'ğŸ‹ Pandas.' },
        'VN': { biome: 'Jungle', chinese: 'ä¸›æ— CÃ³nglÃ­n', image: 'images/forest.png', farm: 'ğŸ‹ Bamboo.' },
        'JP': { biome: 'Cherry Grove', chinese: 'æ¨±èŠ±æ ‘æ— YÄ«nghuÄ ShÃ¹lÃ­n', image: 'images/forest.png', farm: 'ğŸŒ¸ Pink Petals.' },
        'IS': { biome: 'Basalt Deltas', chinese: 'ç„æ­¦å²©ä¸‰è§’æ´² XuÃ¡nwÇ”yÃ¡n', image: 'images/taiga.png', farm: 'ğŸŒ‹ Magma.' },
        'MG': { biome: 'Mushroom Fields', chinese: 'è˜‘è‡å²› MÃ³gÅ« DÇo', image: 'images/swamp.png', farm: 'ğŸ„ Mooshrooms.' },
        'NP': { biome: 'Jagged Peaks', chinese: 'å°–å³­å±±å³° JiÄnqiÃ o ShÄnfÄ“ng', image: 'images/snowytundra.png', farm: 'ğŸ Goats.' }, 
        'GL': { biome: 'Ice Spikes', chinese: 'å†°åˆºå¹³åŸ BÄ«ng CÃ¬', image: 'images/snowytundra.png', farm: 'âŒ Polar Bears.', force: true },
        'RU': { biome: 'Snowy Taiga', chinese: 'ç§¯é›ªé’ˆå¶æ— JÄ«xuÄ› ZhÄ“nyÃ¨lÃ­n', image: 'images/taiga.png', farm: 'ğŸŒ² Foxes.' },
        'CA': { biome: 'Taiga', chinese: 'é’ˆå¶æ— ZhÄ“nyÃ¨lÃ­n', image: 'images/taiga.png', farm: 'ğŸŒ² Spruce.' },
    };

    // --- OCEAN LOGIC (Correct Minecraft Variants) ---
    function getOceanBiome(temp, isDeep) {
        let name = "Ocean";
        let chinese = "æµ·æ´‹ HÇiyÃ¡ng";
        let img = "images/swamp.png"; // Placeholder for water
        let farm = "ğŸŸ Cod & Squid.";

        if (temp < -2) {
             name = isDeep ? "Deep Frozen Ocean" : "Frozen Ocean";
             chinese = isDeep ? "æ·±å†»æ´‹ ShÄ“n DÃ²ngyÃ¡ng" : "å†»æ´‹ DÃ²ngyÃ¡ng";
             img = "images/snowytundra.png"; 
             farm = "â„ï¸ Blue Ice & Polar Bears.";
        } 
        else if (temp < 10) {
             name = isDeep ? "Deep Cold Ocean" : "Cold Ocean";
             chinese = isDeep ? "æ·±å†·æ°´æµ·æ´‹ ShÄ“n LÄ›ngshuÇ" : "å†·æ°´æµ·æ´‹ LÄ›ngshuÇ";
             farm = "ğŸŸ Salmon & Cod.";
        }
        else if (temp < 25) {
             name = isDeep ? "Deep Ocean" : "Ocean"; // Normal Ocean
             chinese = isDeep ? "æ·±æµ· ShÄ“nhÇi" : "æµ·æ´‹ HÇiyÃ¡ng";
             farm = "ğŸ¦‘ Glow Squid & Kelp.";
        }
        else if (temp < 30) {
             name = isDeep ? "Deep Lukewarm Ocean" : "Lukewarm Ocean";
             chinese = isDeep ? "æ·±æ¸©æ°´æµ·æ´‹ ShÄ“n WÄ“nshuÇ" : "æ¸©æ°´æµ·æ´‹ WÄ“nshuÇ";
             img = "images/plains.png"; 
             farm = "ğŸ¡ Pufferfish & Tropical Fish.";
        }
        else {
             name = "Warm Ocean"; // Warm ocean is rarely "Deep" in Minecraft logic
             chinese = "æš–æ°´æµ·æ´‹ NuÇnshuÇ";
             img = "images/plains.png"; 
             farm = "ğŸš Coral Reefs & Pickles.";
        }
        return { biome: name, chinese: chinese, image: img, farm: farm };
    }

    // --- LAND LOGIC ---
    function getBiomeByLat(lat, isWater) {
        if (isWater) return { biome: 'River', chinese: 'æ²³æµ HÃ©liÃº', image: 'images/swamp.png', farm: 'ğŸ£ Fishing.' };
        
        const abs = Math.abs(lat);
        if (abs > 60) return { biome: 'Snowy Plains', chinese: 'ç§¯é›ªå¹³åŸ JÄ«xuÄ› PÃ­ngyuÃ¡n', image: 'images/snowytundra.png', farm: 'â„ï¸ Ice.' };
        if (abs > 50) return { biome: 'Old Growth Taiga', chinese: 'åŸç”Ÿé’ˆå¶æ— YuÃ¡nshÄ“ng', image: 'images/taiga.png', farm: 'ğŸŒ² Spruce.' };
        if (abs > 35) return { biome: 'Birch Forest', chinese: 'ç™½æ¡¦æ£®æ— BÃ¡ihuÃ ', image: 'images/forest.png', farm: 'ğŸŒ³ Birch Wood.' };
        if (abs > 23) return { biome: 'Desert', chinese: 'æ²™æ¼  ShÄmÃ²', image: 'images/desert.png', farm: 'ğŸŒµ Cactus.' };
        if (abs > 15) return { biome: 'Savanna Plateau', chinese: 'çƒ­å¸¦é«˜åŸ RÃ¨dÃ i GÄoyuÃ¡n', image: 'images/savanna.png', farm: 'ğŸ¦ Acacia.' };
        if (abs > 0) return { biome: 'Jungle', chinese: 'ä¸›æ— CÃ³nglÃ­n', image: 'images/forest.png', farm: 'ğŸ‹ Bamboo.' };
        return { biome: 'Plains', chinese: 'å¹³åŸ PÃ­ngyuÃ¡n', image: 'images/plains.png', farm: 'ğŸŒ¾ Wheat.' };
    }

    // --- CLICK HANDLER ---
    map.on('click', async (e) => {
        const { lng, lat } = e.lngLat;
        const sidebar = document.getElementById('sidebar');

        // 1. PLACE STEVE MARKER
        if (steveMarker) steveMarker.remove();
        const el = document.createElement('div');
        el.className = 'steve-marker';
        steveMarker = new mapboxgl.Marker(el).setLngLat(e.lngLat).addTo(map);

        // 2. DETECT WATER MAPBOX (Visual check)
        const bbox = [[e.point.x - 10, e.point.y - 10], [e.point.x + 10, e.point.y + 10]];
        const isWaterMapbox = map.queryRenderedFeatures(bbox).some(f => f.layer.id.includes('water') || f.layer.id.includes('ocean'));
        const elevation = map.queryTerrainElevation(e.lngLat) || 0;

        try {
            // A. GEOCODE
            const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
            const geoData = await geoRes.json();
            
            // B. WEATHER
            const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${WEATHER_KEY}`);
            const weatherData = await weatherRes.json();
            const temp = Math.round(weatherData.main.temp);
            const humidity = weatherData.main.humidity;
            const weatherMain = weatherData.weather[0].main; 

            // C. DETERMINE BIOME
            let result;
            const countryCode = geoData.countryCode; 
            const regionName = geoData.principalSubdivision; 
            // Is it legally international waters?
            const isDeepOcean = !geoData.countryName; 

            // --- MASTER LOGIC ---

            // 1. OCEAN OVERRIDE (If Mapbox sees water AND (No Country OR API says water))
            if (isWaterMapbox && (isDeepOcean || geoData.locality === "")) {
                result = getOceanBiome(temp, isDeepOcean);
            }
            // 2. High Elevation
            else if (elevation > 2000) {
                 let snowLine = Math.abs(lat) < 30 ? 4000 : 1500;
                 if (elevation > snowLine) {
                    result = { biome: 'Jagged Peaks', chinese: 'å°–å³­å±±å³° JiÄnqiÃ o', image: 'images/snowytundra.png', farm: 'ğŸ Goats.' };
                 } else {
                    result = { biome: 'Stony Peaks', chinese: 'çŸ³å³° ShÃ­fÄ“ng', image: 'images/savanna.png', farm: 'â›ï¸ Iron.' };
                 }
            }
            // 3. Known Region/Country
            else if (REGION_BIOMES[regionName]) {
                 result = REGION_BIOMES[regionName];
            }
            else if (COUNTRY_BIOMES[countryCode]) {
                 result = COUNTRY_BIOMES[countryCode];
            }
            // 4. Fallback
            else {
                 result = getBiomeByLat(lat, false); // Pass 'false' because we handled real oceans in step 1
            }

            // D. UPDATE UI
            document.getElementById('sb-country').innerText = geoData.countryName || "Deep Ocean";
            document.getElementById('sb-region').innerText = regionName || "";
            
            const flagImg = document.getElementById('sb-flag');
            if (countryCode) {
                flagImg.src = `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }

            document.getElementById('sb-biome').innerText = result.biome;
            document.getElementById('sb-chinese').innerText = result.chinese;
            document.getElementById('sb-image').src = result.image;
            document.getElementById('sb-farm').innerText = result.farm;

            // Stats
            document.getElementById('sb-temp').innerText = temp + "Â°C";
            document.getElementById('sb-elev').innerText = Math.round(elevation) + "m";
            document.getElementById('sb-hum').innerText = humidity + "%";
            
            let precipText = "NONE";
            if (weatherMain === "Rain" || weatherMain === "Drizzle") precipText = "RAIN ğŸŒ§ï¸";
            if (weatherMain === "Snow") precipText = "SNOW â„ï¸";
            if (weatherMain === "Thunderstorm") precipText = "STORM â›ˆï¸";
            document.getElementById('sb-precip').innerText = precipText;

            sidebar.classList.add('active');

        } catch (err) {
            console.error(err);
        }
    });

    function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
    document.addEventListener('mousemove', (e) => {
        const cursor = document.getElementById('cursor-layer');
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
    });
</script>

</body>
</html>