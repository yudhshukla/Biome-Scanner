<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Minecraft Atlas Scanner</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }
        
        /* Cursor */
        #map { cursor: none; width: 100%; height: 100%; position: absolute; }
        #cursor-layer { position: fixed; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .crosshair { width: 24px; height: 24px; position: relative; transform: translate(-50%, -50%); }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 2px black; }
        .crosshair::before { top: 11px; left: 0; width: 24px; height: 2px; }
        .crosshair::after { top: 0; left: 11px; width: 2px; height: 24px; }

        /* Sidebar */
        #sidebar {
            position: absolute; top: 0; right: -600px; width: 550px; height: 100%;
            background: rgba(16, 0, 16, 0.95); border-left: 6px solid #28022e;
            box-shadow: -10px 0 20px rgba(0,0,0,0.8); transition: right 0.3s ease-in-out;
            z-index: 100; padding: 30px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column;
        }
        #sidebar.active { right: 0; }
        
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #ff5555; }
        
        /* Header */
        .header-container { display: flex; align-items: center; margin-bottom: 20px; border-bottom: 2px dashed #444; padding-bottom: 15px; }
        .country-flag { width: 80px; height: 50px; border: 3px solid #fff; margin-right: 20px; box-shadow: 4px 4px 0 #000; }
        .country-name { font-size: 16px; color: #ffff55; line-height: 1.5; text-transform: uppercase; }

        /* Biome Image */
        .sidebar-image-container { width: 100%; height: 250px; border: 4px solid #555; margin-bottom: 15px; background: #000; position: relative; }
        .sidebar-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }

        /* Biome Title */
        h1 { font-size: 20px; color: #fff; margin: 0; text-transform: uppercase; text-shadow: 3px 3px 0 #000; margin-bottom: 8px; line-height: 1.4; }
        h2 { font-size: 14px; color: #ffff55; margin: 0 0 20px 0; border-bottom: 2px dashed #444; padding-bottom: 15px; }
        
        /* Stats Grid - BIGGER NOW */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px; }
        .stat-box { background: rgba(255,255,255,0.08); padding: 15px; border: 3px solid #333; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .label { color: #aaa; font-size: 10px; margin-bottom: 8px; display: block; letter-spacing: 1px; }
        .value { color: #fff; font-size: 14px; font-weight: bold; text-shadow: 2px 2px 0 #000; }

        .farming-box { margin-top: auto; border: 2px solid #2ecc71; background: rgba(46, 204, 113, 0.1); padding: 20px; font-size: 12px; color: #2ecc71; line-height: 1.6; }
    </style>
</head>
<body>

<div id="cursor-layer"><div class="crosshair"></div></div>
<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">[X]</div>
    
    <div class="header-container">
        <img id="sb-flag" class="country-flag" src="" style="display:none;">
        <div id="sb-country" class="country-name">Scanning...</div>
    </div>

    <div class="sidebar-image-container"><img id="sb-image" src="" class="sidebar-img"></div>
    
    <h1 id="sb-biome">Unknown</h1>
    <h2 id="sb-chinese">...</h2>
    
    <div class="stat-grid">
        <div class="stat-box">
            <span class="label">TEMP</span>
            <span class="value" id="sb-temp">--</span>
        </div>
        <div class="stat-box">
            <span class="label">SKY</span>
            <span class="value" id="sb-sky">--</span>
        </div>
        <div class="stat-box">
            <span class="label">ELEVATION</span>
            <span class="value" id="sb-elev">--</span>
        </div>
        <div class="stat-box">
            <span class="label">HUMIDITY</span>
            <span class="value" id="sb-hum">--</span>
        </div>
    </div>

    <div class="farming-box" id="sb-farm">Click a country to scan.</div>
</div>

<script>
    const MAPBOX_KEY = config.MAPBOX_KEY;
    const WEATHER_KEY = config.WEATHER_KEY;

    mapboxgl.accessToken = MAPBOX_KEY;

    // 1. SETUP MAP
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-streets-v12', 
        center: [30.0, 20.0], 
        zoom: 2.5,
        projection: 'globe' 
    });

    map.on('style.load', () => {
        map.addSource('mapbox-dem', {
            'type': 'raster-dem',
            'url': 'mapbox://mapbox.mapbox-terrain-dem-v1',
            'tileSize': 512,
            'maxzoom': 14
        });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
        map.setFog({ 'color': 'rgb(10, 10, 20)', 'high-color': 'rgb(30, 30, 50)', 'horizon-blend': 0.1, 'star-intensity': 0.6 });
    });

    // --- 2. OFFICIAL MINECRAFT BIOME LIST ---
    // Added 'force: true' to prevent Elevation logic from overwriting (Fixes Greenland)
    const COUNTRY_BIOMES = {
        // --- DESERTS ---
        'SA': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus & Oil.' }, 
        'EG': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Sugar Cane.' },
        'AE': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus.' },
        'IQ': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus.' },
        'DZ': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus.' },
        'LY': { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus.' },
        'OM': { biome: 'Badlands', chinese: 'æ¶åœ°', image: 'images/desert.png', farm: 'â›ï¸ Gold Mines.' },
        'AU': { biome: 'Red Sand Badlands', chinese: 'çº¢æ²™æ¶åœ°', image: 'images/desert.png', farm: 'ðŸ•·ï¸ Spiders & Gold.' },
        'MX': { biome: 'Wooded Badlands', chinese: 'ç¹èŒ‚æ¶åœ°', image: 'images/desert.png', farm: 'ðŸŒµ Cactus & Gold.' },
        'NA': { biome: 'Red Sand Desert', chinese: 'çº¢æ²™æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Dead Bushes.' },

        // --- JUNGLES ---
        'BR': { biome: 'Sparse Jungle', chinese: 'ç¨€ç–ä¸›æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Bamboo & Cocoa.' },
        'ID': { biome: 'Bamboo Jungle', chinese: 'ç«¹æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Bamboo & Pandas.' },
        'VN': { biome: 'Jungle', chinese: 'ä¸›æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Bamboo.' },
        'TH': { biome: 'Jungle', chinese: 'ä¸›æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Bamboo.' },
        'CO': { biome: 'Lush Caves', chinese: 'ç¹èŒ‚æ´žç©´', image: 'images/forest.png', farm: 'ðŸ€ Glow Berries.' }, 
        'IN': { biome: 'Jungle Edge', chinese: 'ä¸›æž—è¾¹ç¼˜', image: 'images/forest.png', farm: 'ðŸ… Tigers & Bamboo.' },

        // --- SPECIAL / RARE ---
        'JP': { biome: 'Cherry Grove', chinese: 'æ¨±èŠ±æ ‘æž—', image: 'images/forest.png', farm: 'ðŸŒ¸ Pink Petals.' },
        'IS': { biome: 'Basalt Deltas', chinese: 'çŽ„æ­¦å²©ä¸‰è§’æ´²', image: 'images/taiga.png', farm: 'ðŸŒ‹ Magma Cubes.' },
        'MG': { biome: 'Mushroom Fields', chinese: 'è˜‘è‡å²›', image: 'images/swamp.png', farm: 'ðŸ„ Mooshrooms.' },
        'NP': { biome: 'Jagged Peaks', chinese: 'å°–å³­å±±å³°', image: 'images/snowytundra.png', farm: 'ðŸ Goats & Ice.' }, 
        'CH': { biome: 'Stony Peaks', chinese: 'çŸ³å³°', image: 'images/snowytundra.png', farm: 'ðŸ Goats & Emeralds.' },

        // --- SNOW / ICE ---
        'RU': { biome: 'Snowy Taiga', chinese: 'ç§¯é›ªé’ˆå¶æž—', image: 'images/taiga.png', farm: 'ðŸŒ² Spruce & Foxes.' },
        'CA': { biome: 'Old Growth Pine Taiga', chinese: 'åŽŸç”Ÿæ¾æœ¨é’ˆå¶æž—', image: 'images/taiga.png', farm: 'ðŸŒ² Spruce & Wolves.' },
        'NO': { biome: 'Snowy Slopes', chinese: 'ç§¯é›ªå±±å¡', image: 'images/snowytundra.png', farm: 'â„ï¸ Powder Snow.' },
        'FI': { biome: 'Taiga', chinese: 'é’ˆå¶æž—', image: 'images/taiga.png', farm: ' berries.' },
        'GL': { biome: 'Ice Spikes', chinese: 'å†°åˆºå¹³åŽŸ', image: 'images/snowytundra.png', farm: 'âŒ Polar Bears.', force: true }, // FORCE OVERRIDE
        'AQ': { biome: 'Ice Spikes', chinese: 'å†°åˆºå¹³åŽŸ', image: 'images/snowytundra.png', farm: 'âŒ Penguins.', force: true },

        // --- PLAINS / FORESTS ---
        'US': { biome: 'Plains', chinese: 'å¹³åŽŸ', image: 'images/plains.png', farm: 'ðŸŒ¾ Wheat & Cows.' },
        'CN': { biome: 'Bamboo Jungle', chinese: 'ç«¹æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Pandas.' },
        'GB': { biome: 'Birch Forest', chinese: 'ç™½æ¡¦æ£®æž—', image: 'images/forest.png', farm: 'ðŸŽ Sheep & Rain.' },
        'IE': { biome: 'Lush Caves', chinese: 'ç¹èŒ‚æ´žç©´', image: 'images/plains.png', farm: 'ðŸ€ Glow Berries.' },
        'ZA': { biome: 'Savanna Plateau', chinese: 'çƒ­å¸¦é«˜åŽŸ', image: 'images/savanna.png', farm: 'ðŸŒ³ Acacia.' },
        'KE': { biome: 'Windswept Savanna', chinese: 'ç‹‚é£Žçƒ­å¸¦è‰åŽŸ', image: 'images/savanna.png', farm: 'ðŸ¦ Lions & Acacia.' },
        'DE': { biome: 'Dark Forest', chinese: 'é»‘æ£®æž—', image: 'images/forest.png', farm: 'ðŸ„ Mushrooms.' },
    };

    function getBiomeByLat(lat, isWater) {
        if (isWater) return { biome: 'Deep Ocean', chinese: 'æ·±æµ·', image: 'images/swamp.png', farm: 'ðŸ¦‘ Squid & Guardians.' };
        
        const abs = Math.abs(lat);
        if (abs > 60) return { biome: 'Snowy Plains', chinese: 'ç§¯é›ªå¹³åŽŸ', image: 'images/snowytundra.png', farm: 'â„ï¸ Ice.' };
        if (abs > 50) return { biome: 'Taiga', chinese: 'é’ˆå¶æž—', image: 'images/taiga.png', farm: 'ðŸŒ² Spruce.' };
        if (abs > 35) return { biome: 'Plains', chinese: 'å¹³åŽŸ', image: 'images/plains.png', farm: 'ðŸŒ¾ Wheat.' };
        if (abs > 23) return { biome: 'Desert', chinese: 'æ²™æ¼ ', image: 'images/desert.png', farm: 'ðŸŒµ Cactus.' };
        if (abs > 10) return { biome: 'Savanna', chinese: 'çƒ­å¸¦è‰åŽŸ', image: 'images/savanna.png', farm: 'ðŸŒ³ Acacia.' };
        return { biome: 'Jungle', chinese: 'ä¸›æž—', image: 'images/forest.png', farm: 'ðŸŽ‹ Bamboo.' };
    }

    // --- 3. CLICK HANDLER ---
    map.on('click', async (e) => {
        const { lng, lat } = e.lngLat;
        const sidebar = document.getElementById('sidebar');

        // Check for Water
        const bbox = [[e.point.x - 10, e.point.y - 10], [e.point.x + 10, e.point.y + 10]];
        const features = map.queryRenderedFeatures(bbox);
        const isWater = features.some(f => f.layer.id.includes('water') || f.layer.id.includes('ocean'));

        // Check Elevation
        const elevation = map.queryTerrainElevation(e.lngLat) || 0;

        try {
            // A. FETCH COUNTRY DATA
            const geoRes = await fetch(`https://api.bigdatacloud.net/data/reverse-geocode-client?latitude=${lat}&longitude=${lng}&localityLanguage=en`);
            const geoData = await geoRes.json();
            
            // B. FETCH WEATHER DATA
            const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${WEATHER_KEY}`);
            const weatherData = await weatherRes.json();

            const temp = Math.round(weatherData.main.temp);
            const humidity = weatherData.main.humidity;
            const sky = weatherData.weather[0].description; 

            // C. DETERMINE BIOME
            let result;
            const countryCode = geoData.countryCode;
            const countryDef = COUNTRY_BIOMES[countryCode];

            // Priority Logic:
            // 1. If country has "force: true" (e.g. Greenland), USE IT.
            if (countryDef && countryDef.force) {
                 result = countryDef;
            }
            // 2. High Elevation -> Jagged Peaks (unless forced)
            else if (elevation > 2000) {
                 result = { biome: 'Jagged Peaks', chinese: 'å°–å³­å±±å³°', image: 'images/snowytundra.png', farm: 'ðŸ Goats & Emeralds.' };
            }
            else if (elevation > 1200) {
                 result = { biome: 'Stony Peaks', chinese: 'çŸ³å³°', image: 'images/savanna.png', farm: 'â›ï¸ Iron & Coal.' };
            }
            // 3. Water
            else if (isWater) {
                 result = getBiomeByLat(lat, true);
            }
            // 4. Specific Country Definition
            else if (countryDef) {
                 result = countryDef;
            }
            // 5. Fallback
            else {
                 result = getBiomeByLat(lat, false);
            }

            // D. UPDATE UI
            document.getElementById('sb-country').innerText = geoData.countryName || "Unknown Territory";
            
            // Flag
            const flagImg = document.getElementById('sb-flag');
            if (countryCode) {
                flagImg.src = `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
                flagImg.style.display = 'block';
            } else {
                flagImg.style.display = 'none';
            }

            document.getElementById('sb-biome').innerText = result.biome;
            document.getElementById('sb-chinese').innerText = result.chinese;
            document.getElementById('sb-image').src = result.image;
            document.getElementById('sb-farm').innerText = result.farm;

            // Live Stats (Bigger now)
            document.getElementById('sb-temp').innerText = temp + "Â°C";
            document.getElementById('sb-sky').innerText = sky.toUpperCase();
            document.getElementById('sb-elev').innerText = Math.round(elevation) + "m";
            document.getElementById('sb-hum').innerText = humidity + "%";

            sidebar.classList.add('active');

        } catch (err) {
            console.error(err);
        }
    });

    function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }

    document.addEventListener('mousemove', (e) => {
        const cursor = document.getElementById('cursor-layer');
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
    });
</script>

</body>
</html>