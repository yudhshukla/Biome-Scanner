<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Minecraft Atlas Scanner</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.css" rel="stylesheet">
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.1.2/mapbox-gl.js"></script>
    <script src="config.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@700&display=swap" rel="stylesheet">
    
    <style>
        body { margin: 0; padding: 0; font-family: 'Press Start 2P', cursive; overflow: hidden; background: #000; }
        
        #map { cursor: none; width: 100%; height: 100%; position: absolute; }
        #cursor-layer { position: fixed; pointer-events: none; z-index: 9999; mix-blend-mode: difference; }
        .crosshair { width: 24px; height: 24px; position: relative; transform: translate(-50%, -50%); }
        .crosshair::before, .crosshair::after { content: ''; position: absolute; background: white; box-shadow: 0 0 2px black; }
        .crosshair::before { top: 11px; left: 0; width: 24px; height: 2px; }
        .crosshair::after { top: 0; left: 11px; width: 2px; height: 24px; }

        .steve-marker {
            width: 32px; height: 64px;
            background-image: url('images/steve.png');
            background-size: contain; background-repeat: no-repeat; background-position: center;
            image-rendering: pixelated; 
        }

        #sidebar {
            position: absolute; top: 0; right: -600px; width: 550px; height: 100%;
            background: rgba(16, 0, 16, 0.95); border-left: 6px solid #28022e;
            box-shadow: -10px 0 20px rgba(0,0,0,0.8); transition: right 0.3s ease-in-out;
            z-index: 100; padding: 30px; box-sizing: border-box; color: white;
            display: flex; flex-direction: column; overflow-y: auto;
        }
        #sidebar.active { right: 0; }
        
        .close-btn { position: absolute; top: 20px; right: 20px; cursor: pointer; font-size: 24px; color: #ff5555; }
        
        .header-container { display: flex; align-items: center; margin-bottom: 25px; border-bottom: 2px dashed #444; padding-bottom: 20px; }
        .country-flag { width: 80px; height: 50px; border: 3px solid #fff; margin-right: 20px; box-shadow: 4px 4px 0 #000; }
        .country-info { display: flex; flex-direction: column; }
        .country-name { font-size: 16px; color: #ffff55; line-height: 1.5; text-transform: uppercase; margin-bottom: 5px; }
        .region-name { font-size: 10px; color: #aaa; text-transform: uppercase; }

        .sidebar-image-container { width: 100%; height: 250px; border: 4px solid #555; margin-bottom: 25px; background: #000; position: relative; }
        .sidebar-img { width: 100%; height: 100%; object-fit: cover; image-rendering: pixelated; }

        h1 { font-size: 24px; color: #fff; margin: 0; text-transform: uppercase; text-shadow: 3px 3px 0 #000; margin-bottom: 12px; line-height: 1.4; }
        h2 { font-family: 'Noto Sans SC', sans-serif; font-size: 20px; color: #f1c40f; margin: 0 0 25px 0; border-bottom: 2px dashed #444; padding-bottom: 20px; letter-spacing: 1px; }
        
        /* BIGGER STATS */
        .stat-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 30px; }
        .stat-box { background: rgba(255,255,255,0.08); padding: 15px; border: 3px solid #333; display: flex; flex-direction: column; justify-content: center; align-items: center; text-align: center; }
        .label { color: #aaa; font-size: 10px; margin-bottom: 10px; display: block; letter-spacing: 1px; }
        .value { color: #fff; font-size: 14px; font-weight: bold; text-shadow: 2px 2px 0 #000; }

        /* BIGGER MOBS */
        .mob-list { margin-bottom: 20px; }
        .mob-title { font-size: 12px; color: #aaa; margin-bottom: 10px; border-bottom: 1px solid #444; padding-bottom: 6px; letter-spacing: 1px;}
        .mobs { font-size: 16px; color: #2ecc71; line-height: 1.8; text-shadow: 1px 1px 0 #000; }
        
    </style>
</head>
<body>

<div id="cursor-layer"><div class="crosshair"></div></div>
<div id="map"></div>

<div id="sidebar">
    <div class="close-btn" onclick="closeSidebar()">[X]</div>
    
    <div class="header-container">
        <img id="sb-flag" class="country-flag" src="" style="display:none;">
        <div class="country-info">
            <div id="sb-country" class="country-name">Scanning...</div>
            <div id="sb-region" class="region-name">...</div>
        </div>
    </div>

    <div class="sidebar-image-container"><img id="sb-image" src="" class="sidebar-img"></div>
    
    <h1 id="sb-biome">Unknown</h1>
    <h2 id="sb-chinese">...</h2>
    
    <div class="stat-grid">
        <div class="stat-box"><span class="label">TEMP</span><span class="value" id="sb-temp">--</span></div>
        <div class="stat-box"><span class="label">TIME</span><span class="value" id="sb-time">--</span></div>
        <div class="stat-box"><span class="label">ELEV</span><span class="value" id="sb-elev">--</span></div>
        <div class="stat-box"><span class="label">PRECIPITATION</span><span class="value" id="sb-precip">--</span></div>
        <div class="stat-box"><span class="label">HUMIDITY</span><span class="value" id="sb-hum">--</span></div>
        <div class="stat-box"><span class="label">COORDS</span><span class="value" id="sb-coords">--</span></div>
    </div>

    <div class="mob-list">
        <div class="mob-title">LIKELY MOBS</div>
        <div class="mobs" id="sb-mobs">--</div>
    </div>
</div>

<script>
    const MAPBOX_KEY = config.MAPBOX_KEY;
    const WEATHER_KEY = config.WEATHER_KEY;

    mapboxgl.accessToken = MAPBOX_KEY;

    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/satellite-v9',
        center: [30.0, 20.0], 
        zoom: 2.5,
        projection: 'globe' 
    });

    let steveMarker = null;

    map.on('style.load', () => {
        map.addSource('mapbox-dem', { 'type': 'raster-dem', 'url': 'mapbox://mapbox.mapbox-terrain-dem-v1', 'tileSize': 512, 'maxzoom': 14 });
        map.setTerrain({ 'source': 'mapbox-dem', 'exaggeration': 1.5 });
        map.setFog({ 'color': 'rgb(10, 10, 20)', 'high-color': 'rgb(30, 30, 50)', 'horizon-blend': 0.1, 'star-intensity': 0.6 });
    });

    // --- BIOME DATA (Cleaned Images & Pinyin) ---
    const BIOME_DATA = {
        'Badlands': { chinese: 'ÊÅ∂Âú∞ √àd√¨', image: 'images/badlands.png', mobs: 'Spiders (Night)' },
        'Desert': { chinese: 'Ê≤ôÊº† ShƒÅm√≤', image: 'images/desert.png', mobs: 'Husks, Rabbits' },
        'Mangrove Swamp': { chinese: 'Á∫¢Ê†ëÊûóÊ≤ºÊ≥Ω H√≥ngsh√πl√≠n', image: 'images/mangroveswamp.png', mobs: 'Warm Frogs, Slimes' },
        'Swamp': { chinese: 'Ê≤ºÊ≥Ω Zh«éoz√©', image: 'images/swamp.png', mobs: 'Slimes, Witches' },
        'Snowy Taiga': { chinese: 'ÁßØÈõ™ÈíàÂè∂Êûó Jƒ´xuƒõ Zhƒìny√®l√≠n', image: 'images/snowytaiga.png', mobs: 'Foxes (White), Wolves' },
        'Tropical Jungle': { chinese: 'ÁÉ≠Â∏¶‰∏õÊûó R√®d√†i C√≥ngl√≠n', image: 'images/tropicaljungle.png', mobs: 'Ocelots, Parrots' },
        'Snowy Tundra': { chinese: 'ÂÜªÂéü D√≤ngyu√°n', image: 'images/snowytundra.png', mobs: 'Strays, Polar Bears' },
        'Sparse Jungle': { chinese: 'Á®ÄÁñè‰∏õÊûó Xƒ´sh≈´ C√≥ngl√≠n', image: 'images/sparsejungle.png', mobs: 'Pandas, Parrots' },
        'Bamboo Jungle': { chinese: 'Á´πÊûó Zh√∫l√≠n', image: 'images/bamboojungle.png', mobs: 'Pandas' },
        'Jungle': { chinese: '‰∏õÊûó C√≥ngl√≠n', image: 'images/jungle.png', mobs: 'Ocelots, Parrots' },
        'Cherry Grove': { chinese: 'Ê®±Ëä±Ê†ëÊûó Yƒ´nghuƒÅ Sh√πl√≠n', image: 'images/cherrygrove.png', mobs: 'Bees, Sheep' },
        'Basalt Deltas': { chinese: 'ÁéÑÊ≠¶Â≤©‰∏âËßíÊ¥≤ Xu√°nw«îy√°n', image: 'images/basaltdeltas.png', mobs: 'Magma Cubes' },
        'Mushroom Fields': { chinese: 'ËòëËèáÂ≤õ M√≥g≈´ D«éo', image: 'images/mushroomfields.png', mobs: 'Mooshrooms' },
        'Jagged Peaks': { chinese: 'Â∞ñÂ≥≠Â±±Â≥∞ JiƒÅnqi√†o ShƒÅnfƒìng', image: 'images/jaggedpeaks.png', mobs: 'Goats' },
        'Ice Spikes': { chinese: 'ÂÜ∞Âà∫Âπ≥Âéü Bƒ´ng C√¨', image: 'images/icespikes.png', mobs: 'Polar Bears' },
        'Taiga': { chinese: 'ÈíàÂè∂Êûó Zhƒìny√®l√≠n', image: 'images/taiga.png', mobs: 'Foxes, Wolves' },
        'Old Growth Taiga': { chinese: 'ÂéüÁîüÈíàÂè∂Êûó Yu√°nshƒìng', image: 'images/oldgrowthtaiga.png', mobs: 'Wolves' },
        'Birch Forest': { chinese: 'ÁôΩÊ°¶Ê£ÆÊûó B√°ihu√† Sƒìnl√≠n', image: 'images/birchforest.png', mobs: 'Cows, Sheep' },
        'Savanna': { chinese: 'ÁÉ≠Â∏¶ËçâÂéü R√®d√†i C«éoyu√°n', image: 'images/savanna.png', mobs: 'Llamas, Horses' },
        'Savanna Plateau': { chinese: 'ÁÉ≠Â∏¶È´òÂéü R√®d√†i GƒÅoyu√°n', image: 'images/savannaplateau.png', mobs: 'Llamas' },
        'Plains': { chinese: 'Âπ≥Âéü P√≠ngyu√°n', image: 'images/plains.png', mobs: 'Horses, Donkeys' },
        'River': { chinese: 'Ê≤≥ÊµÅ H√©li√∫', image: 'images/river.png', mobs: 'Drowned (Night)' },
        'Stony Peaks': { chinese: 'Áü≥Â≥∞ Sh√≠fƒìng', image: 'images/stonypeaks.png', mobs: 'Goats' },
        
        // OCEAN VARIANTS
        'Ocean': { chinese: 'Êµ∑Ê¥ã H«éiy√°ng', image: 'images/ocean.png', mobs: 'Squid, Dolphins' },
        'Deep Ocean': { chinese: 'Ê∑±Êµ∑ Shƒình«éi', image: 'images/deepocean.png', mobs: 'Guardians' },
        'Frozen Ocean': { chinese: 'ÂÜªÊ¥ã D√≤ng Y√°ng', image: 'images/frozenocean.png', mobs: 'Polar Bears' },
        'Deep Frozen Ocean': { chinese: 'Ê∑±ÂÜªÊ¥ã Shƒìn D√≤ngy√°ng', image: 'images/deepfrozenocean.png', mobs: 'Polar Bears' },
        'Cold Ocean': { chinese: 'ÂÜ∑Ê∞¥Êµ∑Ê¥ã Lƒõngshu«ê', image: 'images/coldocean.png', mobs: 'Salmon, Dolphins' },
        'Deep Cold Ocean': { chinese: 'Ê∑±ÂÜ∑Ê∞¥Êµ∑Ê¥ã Shƒìn Lƒõngshu«ê', image: 'images/deepcoldocean.png', mobs: 'Salmon' },
        'Lukewarm Ocean': { chinese: 'Ê∏©Ê∞¥Êµ∑Ê¥ã Wƒìnshu«ê', image: 'images/lukewarmocean.png', mobs: 'Pufferfish' },
        'Deep Lukewarm Ocean': { chinese: 'Ê∑±Ê∏©Ê∞¥Êµ∑Ê¥ã Shƒìn Wƒìnshu«ê', image: 'images/deeplukewarmocean.png', mobs: 'Pufferfish' },
        'Warm Ocean': { chinese: 'ÊöñÊ∞¥Êµ∑Ê¥ã Nu«énshu«ê', image: 'images/warmocean.png', mobs: 'Tropical Fish' }
    };

    const REGION_MAP = {
        'California': 'Badlands', 'Nevada': 'Desert', 'Arizona': 'Desert', 'Florida': 'Mangrove Swamp', 'Louisiana': 'Swamp', 'Alaska': 'Snowy Taiga', 'Hawaii': 'Tropical Jungle', 'Yukon': 'Snowy Tundra', 'Siberia': 'Snowy Taiga'
    };
    const COUNTRY_MAP = {
        'SA': 'Desert', 'EG': 'Desert', 'AE': 'Desert', 'OM': 'Badlands', 'BR': 'Sparse Jungle', 'ID': 'Bamboo Jungle', 'VN': 'Jungle', 'JP': 'Cherry Grove', 'IS': 'Basalt Deltas', 'MG': 'Mushroom Fields', 'NP': 'Jagged Peaks', 'GL': 'Ice Spikes', 'AQ': 'Ice Spikes', 'RU': 'Snowy Taiga', 'CA': 'Taiga'
    };

    // --- LOGIC FUNCTIONS ---
    function getOceanBiome(temp, isDeep) {
        let prefix = isDeep ? "Deep " : "";
        if (temp < -2) return isDeep ? 'Deep Frozen Ocean' : 'Frozen Ocean';
        if (temp < 10) return isDeep ? 'Deep Cold Ocean' : 'Cold Ocean';
        if (temp < 25) return isDeep ? 'Deep Ocean' : 'Ocean';
        if (temp < 30) return isDeep ? 'Deep Lukewarm Ocean' : 'Lukewarm Ocean';
        return 'Warm Ocean';
    }

    function getBiomeByLat(lat, humidity, elevation) {
        const abs = Math.abs(lat);
        if (abs > 60) return 'Snowy Tundra';
        if (abs > 50) return (humidity > 60) ? 'Old Growth Taiga' : 'Taiga';
        if (abs > 35) return (humidity > 70) ? 'Birch Forest' : 'Plains';
        if (abs > 23) {
            if (humidity > 70) return 'Mangrove Swamp';
            if (humidity < 30) return 'Desert';
            return (elevation > 1000) ? 'Savanna Plateau' : 'Savanna';
        }
        if (abs >= 0) {
            if (humidity > 80) return 'Bamboo Jungle';
            if (humidity > 50) return 'Jungle';
            if (humidity < 40) return 'Sparse Jungle';
            return 'Jungle';
        }
        return 'Plains';
    }

    map.on('click', async (e) => {
        const { lng, lat } = e.lngLat;
        const sidebar = document.getElementById('sidebar');

        if (steveMarker) steveMarker.remove();
        const el = document.createElement('div');
        el.className = 'steve-marker';
        steveMarker = new mapboxgl.Marker(el).setLngLat(e.lngLat).addTo(map);

        const elevation = map.queryTerrainElevation(e.lngLat) || 0;

        let geoData = { countryCode: null, countryName: null, regionName: null };
        let weatherData = { main: { temp: 20, humidity: 50 }, weather: [{ main: 'Clear' }], timezone: 0 };
        
        try {
            const mapboxUrl = `https://api.mapbox.com/geocoding/v5/mapbox.places/${lng},${lat}.json?types=country,region&access_token=${MAPBOX_KEY}`;
            const mbRes = await fetch(mapboxUrl);
            const mbJson = await mbRes.json();
            
            if (mbJson.features && mbJson.features.length > 0) {
                const countryFeat = mbJson.features.find(f => f.id.startsWith('country'));
                if (countryFeat) {
                    geoData.countryName = countryFeat.text;
                    if (countryFeat.properties && countryFeat.properties.short_code) {
                        geoData.countryCode = countryFeat.properties.short_code.toUpperCase();
                    }
                }
                const regionFeat = mbJson.features.find(f => f.id.startsWith('region'));
                if (regionFeat) {
                    geoData.regionName = regionFeat.text;
                }
            }
        } catch (e) { console.warn("GeoAPI Failed"); }

        try {
            const weatherRes = await fetch(`https://api.openweathermap.org/data/2.5/weather?lat=${lat}&lon=${lng}&units=metric&appid=${WEATHER_KEY}`);
            if (weatherRes.ok) weatherData = await weatherRes.json();
        } catch (e) { 
            const absLat = Math.abs(lat);
            weatherData.main.temp = 30 - (absLat * 0.5) - (elevation / 200);
        }

        const temp = Math.round(weatherData.main.temp);
        const humidity = weatherData.main.humidity;
        const weatherMain = weatherData.weather[0].main;
        const hours = new Date().getHours(); 
        const isNight = hours < 6 || hours > 18;
        const timeString = isNight ? "NIGHT" : "DAY";

        let biomeKey = "Plains";
        const countryCode = geoData.countryCode; 
        const regionName = geoData.regionName; 
        
        const isDeepOcean = !countryCode;

        if (isDeepOcean) {
            if (lat < -60 && elevation > 10) biomeKey = 'Ice Spikes'; 
            else biomeKey = getOceanBiome(temp, isDeepOcean);
        }
        else if (elevation > 2000) {
            let snowLine = Math.abs(lat) < 30 ? 4000 : 1500;
            biomeKey = (elevation > snowLine) ? 'Jagged Peaks' : 'Stony Peaks';
        }
        else if (REGION_MAP[regionName]) biomeKey = REGION_MAP[regionName];
        else if (COUNTRY_MAP[countryCode]) biomeKey = COUNTRY_MAP[countryCode];
        else biomeKey = getBiomeByLat(lat, humidity, elevation); 

        if (!BIOME_DATA[biomeKey]) biomeKey = 'Plains';
        const data = BIOME_DATA[biomeKey];

        let displayName = geoData.countryName || "Deep Ocean";
        if (lat < -60 && elevation > 10) displayName = "Antarctica";

        document.getElementById('sb-country').innerText = displayName;
        document.getElementById('sb-region').innerText = regionName || "";
        
        const flagImg = document.getElementById('sb-flag');
        if (countryCode) {
            flagImg.src = `https://flagcdn.com/w80/${countryCode.toLowerCase()}.png`;
            flagImg.style.display = 'block';
        } else {
            flagImg.style.display = 'none';
        }

        document.getElementById('sb-biome').innerText = biomeKey;
        document.getElementById('sb-chinese').innerText = data.chinese;
        document.getElementById('sb-image').src = data.image;
        document.getElementById('sb-mobs').innerText = data.mobs;

        document.getElementById('sb-temp').innerText = temp + "¬∞C";

        let safeElev = Math.round(elevation);
        if (safeElev < 0) safeElev = 0; 

        document.getElementById('sb-elev').innerText = safeElev + "m";
        
        document.getElementById('sb-hum').innerText = humidity + "%";
        document.getElementById('sb-time').innerText = timeString;
        document.getElementById('sb-coords').innerText = `${lat.toFixed(1)}, ${lng.toFixed(1)}`;
        
        let precipText = "NONE";
        if (weatherMain === "Rain" || weatherMain === "Drizzle") precipText = "RAIN üåßÔ∏è";
        if (weatherMain === "Snow") precipText = "SNOW ‚ùÑÔ∏è";
        if (weatherMain === "Thunderstorm") precipText = "STORM ‚õàÔ∏è";
        document.getElementById('sb-precip').innerText = precipText;

        sidebar.classList.add('active');
    });

    function closeSidebar() { document.getElementById('sidebar').classList.remove('active'); }
    document.addEventListener('mousemove', (e) => {
        const cursor = document.getElementById('cursor-layer');
        cursor.style.left = e.clientX + 'px';
        cursor.style.top = e.clientY + 'px';
    });
</script>

</body>
</html>